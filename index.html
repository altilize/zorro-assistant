<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zorro</title>
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-color: #09090b; /* Zinc-950 (Hampir hitam) */
            --chat-bg: #09090b;
            --user-bubble: #fafafa; /* Putih */
            --user-text: #18181b; /* Hitam */
            --ai-bubble: #27272a; /* Zinc-800 */
            --ai-text: #e4e4e7; /* Zinc-200 */
            --accent: #2563eb; /* Biru kalem (opsional) */
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--ai-text);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100dvh; /* Dynamic viewport height */
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 1px;
            color: #71717a; /* Warna abu samar */
            text-transform: uppercase;
        }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* Scrollbar minimalis */
        #chat-container::-webkit-scrollbar { width: 5px; }
        #chat-container::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .zorro {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            color: var(--ai-text);
            border-bottom-left-radius: 4px;
        }

        .user {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        .typing-indicator {
            font-size: 12px; color: #555; margin-left: 10px; margin-bottom: 10px; display: none;
        }

        /* --- INPUT AREA --- */
        #input-area {
            padding: 20px;
            background: rgba(9, 9, 11, 0.95); /* Sedikit transparan */
            backdrop-filter: blur(10px);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 15px 20px;
            border-radius: 30px;
            border: 1px solid #333;
            background: #18181b;
            color: white;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        #user-input:focus { border-color: #555; }

        button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #27272a;
            color: white;
            transition: all 0.2s;
        }

        button:hover { background: #3f3f46; }
        button:disabled { opacity: 0.5; cursor: default; }
        
        button svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- MODAL (API KEY) --- */
        #key-modal {
            position: fixed; inset: 0;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: opacity 0.5s;
        }
        
        #key-modal.hidden { opacity: 0; pointer-events: none; }

        .modal-content { text-align: center; max-width: 400px; width: 100%; }
        .modal-content h2 { font-weight: 400; font-size: 24px; margin-bottom: 10px; }
        .modal-content p { color: #888; font-size: 14px; margin-bottom: 30px; }
        
        #api-input {
            width: 100%; padding: 15px; border-radius: 10px;
            border: 1px solid #333; background: #111; color: white;
            text-align: center; font-family: monospace; font-size: 14px;
            margin-bottom: 20px; box-sizing: border-box;
        }
        
        .btn-primary {
            width: 100%; padding: 15px; background: #fff; color: #000;
            font-weight: 600; border-radius: 10px; border: none; font-size: 14px;
        }

    </style>
</head>
<body>

    <div id="key-modal">
        <div class="modal-content">
            <h2>Selamat Datang, Moses.</h2>
            <p>Masukkan kunci akses Groq Anda untuk mengaktifkan Zorro.</p>
            <input type="password" id="api-input" placeholder="gsk_xxxxxxxxxxxxxxxxxxxx">
            <button class="btn-primary" onclick="saveKey()">Masuk</button>
        </div>
    </div>

    <header>ZORRO &bull; PERSONAL ASSISTANT</header>

    <div id="chat-container">
        <div class="message zorro">
            Yo Moses. Ready to code or what?
        </div>
    </div>
    
    <div class="typing-indicator" id="typing">Zorro is typing...</div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="Tanya sesuatu..." autocomplete="off" onkeypress="handleEnter(event)">
        
        <button onclick="toggleVoice()" id="mic-btn" title="Bicara">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>

        <button onclick="sendMessage()" id="send-btn" title="Kirim">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

    <script>
        // --- LOGIC (SAMA SEPERTI SEBELUMNYA) ---
        
        const SYSTEM_PROMPT = "You are Zorro, AI assistant milik Moses. Gaya bicara lo 'Anak Jaksel' (campur English). Sifat lo sarkas, witty, dan suka roasting Moses kalau nanya hal basic. Lo expert di bidang Robotika, Coding ESP32, dan Networking. Jawab singkat dan to the point.";
        
        let apiKey = localStorage.getItem("groq_key_v2"); // Pakai key v2 biar fresh
        const chatBox = document.getElementById("chat-container");
        const typingInd = document.getElementById("typing");

        if (apiKey) {
            document.getElementById("key-modal").classList.add("hidden");
        }

        function saveKey() {
            const input = document.getElementById("api-input").value.trim();
            if (input.startsWith("gsk_")) {
                localStorage.setItem("groq_key_v2", input);
                apiKey = input;
                document.getElementById("key-modal").classList.add("hidden");
            } else {
                alert("Key tidak valid. Harus diawali 'gsk_'");
            }
        }

        function handleEnter(e) {
            if (e.key === "Enter") sendMessage();
        }

        function appendMessage(role, text) {
            const div = document.createElement("div");
            div.className = `message ${role}`;
            
            // Format teks sederhana (bolding **text**)
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            div.innerHTML = formattedText;
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const inputField = document.getElementById("user-input");
            const text = inputField.value.trim();
            if (!text) return;

            inputField.value = "";
            inputField.blur(); // Tutup keyboard di HP
            appendMessage("user", text);
            
            typingInd.style.display = "block";

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: text }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                typingInd.style.display = "none";

                if (data.error) throw new Error(data.error.message);
                
                const reply = data.choices[0].message.content;
                appendMessage("zorro", reply);
                
                // Speak
                const utterance = new SpeechSynthesisUtterance(reply);
                utterance.lang = 'id-ID';
                utterance.rate = 1.1;
                window.speechSynthesis.speak(utterance);

            } catch (err) {
                typingInd.style.display = "none";
                appendMessage("zorro", "⚠️ Error: " + err.message);
                if (err.message.includes("401")) {
                    localStorage.removeItem("groq_key_v2");
                    location.reload();
                }
            }
            inputField.focus(); // Fokus balik
        }

        function toggleVoice() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'id-ID';
            recognition.start();
            
            const btn = document.getElementById("mic-btn");
            const originalColor = btn.style.backgroundColor;
            btn.style.backgroundColor = "#ef4444"; // Merah saat record

            recognition.onresult = (event) => {
                const speech = event.results[0][0].transcript;
                document.getElementById("user-input").value = speech;
                sendMessage();
                btn.style.backgroundColor = ""; // Reset warna
            };
            
            recognition.onend = () => {
                btn.style.backgroundColor = "";
            };
        }
    </script>
</body>
</html>